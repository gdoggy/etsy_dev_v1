version: '3.8'

services:
  # --- Go 应用服务 ---
  app:
    container_name: etsy_dev_v1_202512
    build:
      context: .
      dockerfile: Dockerfile
    # 如果你要直接推送，建议这里写上完整的镜像名 (例如: your-dockerhub-user/etsy-api:v1)
    # image: your-registry/etsy-api:latest
    ports:
      - "8080:8080"
    environment:
      # 服务配置
      - SERVER_PORT=8080

      # 数据库配置
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=etsy_admin
      - DB_PASSWORD=1234
      - DB_NAME=etsy_farm
      - DB_TIMEZONE=Asia/Shanghai

      # 万邦 API (1688数据抓取)
      - ONEBOUND_API_KEY=${ONEBOUND_API_KEY:-}
      - ONEBOUND_API_SECRET=${ONEBOUND_API_SECRET:-}

      # Google Gemini AI
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}

      # 云存储配置 (S3/COS)
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-s3}
      - AWS_BUCKET=${AWS_BUCKET:-}
      - AWS_REGION=${AWS_REGION:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_CDN_DOMAIN=${AWS_CDN_DOMAIN:-}
      - STORAGE_BASE_PATH=${STORAGE_BASE_PATH:-etsy-erp}
    depends_on:
      - db
    networks:
      - etsy-net
    restart: on-failure

  # --- PostgreSQL 数据库服务 ---
  db:
    image: postgres:16-alpine
    container_name: etsy_pg_dev
    restart: always
    environment:
      - POSTGRES_USER=etsy_admin
      - POSTGRES_PASSWORD=1234
      - POSTGRES_DB=etsy_farm
      - TZ=Asia/Shanghai      # 修改 Linux 容器系统时间
      - PGTZ=Asia/Shanghai    # 修改 Postgres 默认服务时区
    ports:
      # docker 5432 映射到 Mac 的 5432
      - "5432:5432"
    volumes:
      # 数据持久化：确保容器删除后数据还在
      - pg_data:/var/lib/postgresql/data
    networks:
      - etsy-net

# --- 网络定义 ---
networks:
  etsy-net:
    driver: bridge

# --- 数据卷定义 ---
volumes:
  pg_data: